<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Agendinha de Estudos</title>
<style>
  body {
    font-family: Arial, sans-serif;
    padding: 20px;
    background: #f0f2f5;
    user-select: none;
  }
  h1 {
    color: #5C6AC4;
    margin-bottom: 15px;
  }
  #container {
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
  }
  /* Cada aba tem seus próprios conteúdos */
  .topicsPanel {
    width: 280px;
    max-height: 80vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 5px;
    padding: 15px;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
    display: none;
  }
  .topicsPanel.active {
    display: block;
  }
  .topicsPanel h2 {
    margin-top: 0;
  }

  .topic-item {
    margin: 5px 0;
    padding: 6px 8px;
    border-radius: 4px;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: grab;
    position: relative;
    user-select: none;
  }
  .topic-item:active {
    cursor: grabbing;
  }
  /* Colors by category */
  .matematica { background: #4169e1; }
  .biologia { background: #2e8b57; }
  .quimica { background: #800080; }
  .fisica { background: #b22222; }
  .geografia { background: #fff1c1; color: #5a4d12; }
  .historia { background: #ffd18c; color: #5a4d12; }
  .portugues { background: #f9d5e5; color: #6a1b4d; }
  .filosofia-sociologia-literatura { background: #cde7f0; color: #1a4e7a; }

  #agenda, #monthsContainer, #weekContainer, #radarContainer {
    background: #fff;
    border-radius: 5px;
    padding: 15px;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
  }

  #agenda {
    flex: 1;
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
  }
  #monthsContainer {
    flex: 1;
    display: none;
    margin-top: 20px;
  }
  #monthsGrid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
  }
  #weekContainer {
    flex: 1;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
    margin-top: 20px;
  }
  #weekGrid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 10px;
  }
  .day, .month {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 4px;
    min-height: 150px;
    padding: 10px;
    display: flex;
    flex-direction: column;
  }
  .day h3, .month h4 {
    margin: 0 0 8px 0;
    font-size: 1em;
    border-bottom: 1px solid #ccc;
    padding-bottom: 3px;
    text-align: center;
  }
  .day-content, .month-content, .week-content {
    flex: 1;
    overflow-y: auto;
  }
  .day-content .topic-item, .month-content .topic-item, .week-content .topic-item {
    margin: 4px 0;
    border-radius: 4px;
    padding: 4px 6px;
    cursor: default;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .remove-btn {
    color: #faa;
    font-weight: bold;
    cursor: pointer;
    margin-left: 10px;
    user-select: none;
  }
  .month-content .topic-item {
    display: flex !important;
    align-items: center;
  }
  .month-content .topic-item input.month-check {
    margin-right: 8px;
    cursor: pointer;
    width: 18px;
    height: 18px;
    transition: transform 0.2s ease;
  }
  .month-content .topic-item input.month-check:checked {
    animation: checkScale 0.3s ease forwards;
  }
  @keyframes checkScale {
    0% { transform: scale(1); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  .month-content .topic-item.checked {
    opacity: 0.6;
    background-color: #222;
    color: #bbb;
  }
  .month-content .topic-item.checked span {
    text-decoration: line-through;
  }

  /* Radar */
  #radarContainer {
    display: none;
    margin: 0;
    padding: 15px;
    background: #fff;
    border-radius: 5px;
    flex: 1;
    max-height: 80vh;
    overflow-y: auto;
    box-shadow: 0 0 10px rgb(0 0 0 / 0.1);
  }
  #radarLevels {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    height: 100%;
  }
  .radar-level {
    flex: 1;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    min-height: 400px;
    max-height: 650px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    background-color: #fff;
    color: inherit;
  }
  .radar-level strong {
    font-size: 1em;
    margin-bottom: 8px;
    user-select: none;
    color: #333;
  }
  .radar-level .topic-item {
    user-select: none;
    cursor: grab;
    margin-bottom: 4px;
    padding: 6px 10px 6px 10px;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    color: #fff;
    position: relative;
    transition: background-color 0.3s ease;
  }
  .radar-level .topic-item.matematica { background: #4169e1; color: #fff !important; }
  .radar-level .topic-item.biologia { background: #2e8b57; color: #fff !important; }
  .radar-level .topic-item.quimica { background: #800080; color: #fff !important; }
  .radar-level .topic-item.fisica { background: #b22222; color: #fff !important; }
  .radar-level .topic-item.geografia { background: #fff1c1; color: #5a4d12 !important; }
  .radar-level .topic-item.historia { background: #ffd18c; color: #5a4d12 !important; }
  .radar-level .topic-item.portugues { background: #f9d5e5; color: #6a1b4d !important; }
  .radar-level .topic-item.filosofia-sociologia-literatura { background: #cde7f0; color: #1a4e7a !important; }

  .radar-level .topic-item .remove-btn {
    color: #d44;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    top: 6px;
    right: 6px;
    user-select: none;
    font-size: 18px;
  }
  .radar-level .topic-item .edit-btn {
    position: absolute;
    top: 6px;
    right: 36px;
    font-size: 18px;
    cursor: pointer;
    user-select: none;
  }
  .radar-level .topic-item .edit-btn:hover, .radar-level .topic-item .remove-btn:hover {
    color: #ffdddd;
  }

  /* Checklist box styles for radar */
  .checklist {
    margin-top: 8px;
    padding-left: 12px;
    color: #eee;
    font-size: 0.9em;
  }
  .checklist label {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
    cursor: pointer;
  }
  .checklist input[type="checkbox"] {
    cursor: pointer;
    width: 16px;
    height: 16px;
  }

  /* Edit modal overlay */
  #editModalOverlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    z-index: 10000;
    align-items: center;
    justify-content: center;
  }
  #editModal {
    background: #fff;
    padding: 20px 25px;
    border-radius: 8px;
    width: 360px;
    max-width: 94vw;
    box-shadow: 0 3px 12px rgba(0,0,0,0.3);
    font-size: 14px;
    max-height: 80vh;
    overflow-y: auto;
  }
  #editModal h3 {
    margin-top: 0;
    margin-bottom: 14px;
    font-size: 20px;
  }
  #editModal textarea {
    width: 100%;
    min-height: 150px;
    font-family: inherit;
    font-size: 14px;
    padding: 8px;
    box-sizing: border-box;
    resize: vertical;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  #editModalButtons {
    display: flex;
    justify-content: flex-end;
    gap: 12px;
    margin-top: 12px;
  }
  #editModal button {
    padding: 8px 16px;
    font-size: 14px;
  }

  /* Botões azuis para Salvar, Carregar, Organizar e Radar */
  button {
    background-color: #4169e1; /* azul royal */
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease;
    margin-right: 6px;
    margin-bottom: 10px;
  }
  button:hover {
    background-color: #304bbd;
  }
</style>
</head>
<body>
<h1>Agendinha de Estudos - Arraste os conteúdos</h1>

<button id="saveBtn">Salvar Agenda</button>
<button id="loadBtn">Carregar Agenda</button>
<button id="monthBtn">Organizar por Mês</button>
<button id="weekBtn">Organizar por Semana</button>
<button id="radarBtn">Radar dos conteúdos</button>

<div id="container">

  <!-- Conteúdos para Radar -->
  <div id="topicsRadar" class="topicsPanel">
    <h2>Conteúdos Radar</h2>
  </div>

  <!-- Conteúdos para Mês -->
  <div id="topicsMonth" class="topicsPanel">
    <h2>Conteúdos Mês</h2>
  </div>

  <!-- Conteúdos para Semana -->
  <div id="topicsWeek" class="topicsPanel">
    <h2>Conteúdos Semana</h2>
  </div>

  <!-- Agenda Dias da Semana -->
  <div id="agenda"></div>

  <!-- Meses -->
  <div id="monthsContainer">
    <h3>Organize seus conteúdos por mês</h3>
    <div id="monthsGrid"></div>
  </div>

  <!-- Semana -->
  <div id="weekContainer">
    <h3>Organize seus conteúdos por semana</h3>
    <div id="weekGrid"></div>
  </div>

  <!-- Radar -->
  <div id="radarContainer">
    <div id="radarLevels">
      <div class="radar-level" data-level="0" ondrop="drop(event)" ondragover="allowDrop(event)">
        <strong>Nunca estudei</strong>
        <div class="radar-content"></div>
      </div>
      <div class="radar-level" data-level="1" ondrop="drop(event)" ondragover="allowDrop(event)">
        <strong>Lacuna Teórica</strong>
        <div class="radar-content"></div>
      </div>
      <div class="radar-level" data-level="2" ondrop="drop(event)" ondragover="allowDrop(event)">
        <strong>Já estudei toda a teoria mas erro muitos exercícios</strong>
        <div class="radar-content"></div>
      </div>
      <div class="radar-level" data-level="3" ondrop="drop(event)" ondragover="allowDrop(event)">
        <strong>Domino</strong>
        <div class="radar-content"></div>
      </div>
    </div>
    <button id="radarClearBtn" style="margin-top:15px;">Limpar Radar</button>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModalOverlay">
  <div id="editModal">
    <h3>Editar checklist para conteúdo:</h3>
    <div id="modalTitleName" style="font-weight:bold; margin-bottom:8px;"></div>
    <textarea id="checklistText" placeholder="Escreva uma tarefa por linha. Exemplo:
Assistir videoaula
Fazer 10 questões"></textarea>
    <div id="editModalButtons">
      <button id="cancelEditBtn" type="button">Cancelar</button>
      <button id="saveEditBtn" type="button">Salvar</button>
    </div>
  </div>
</div>

<script>
// --- Dados e tópicos globais ---
const days = [
  "Segunda-feira","Terça-feira","Quarta-feira","Quinta-feira","Sexta-feira","Sábado","Domingo"
];
const months = ["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"];

const mathTopics = [
  "Números e suas operações básicas",
  "Habilidades mentais básicas",
  "Frações e suas propriedades",
  "MMC, MDC e Fatoração",
  "Potenciação e radiciação",
  "Razão e Proporção",
  "Porcentagem",
  "Unidades de Medida",
  "Gráficos e Tabelas",
  "Escalas",
  "Conjuntos",
  "Estatística",
  "Função do primeiro grau",
  "Função do segundo grau",
  "Progressão aritmética",
  "Progressão geométrica",
  "Análise combinatória",
  "Probabilidade",
  "Geometria plana",
  "Geometria espacial",
  "Trigonometria",
  "Logaritmos",
  "Matemática financeira",
  "Equações",
  "Sistemas de equações"
].map(text => ({text, category:"matematica"}));

const bioTopics = [
  "Bioquímica", "Citologia", "Bioenergética", "Biologia Molecular",
  "Biotecnologia e Engenharia Genética", "Citogenética", "Ciclo Celular",
  "Origem da Vida", "Evolução", "Genética", "Ecologia", "Problemas Ambientais",
  "Ciclo Menstrual", "Sistema nervoso", "Sistema digestório",
  "Sistema cardiorrespiratório", "Sistema Imunológico", "Botânica",
  "Zoologia", "Microbiologia", "Histologia", "Sangue", "Doenças", "Drogas",
  "Taxonomia e Classificação dos Seres Vivos", "Reprodução Humana", "Embriologia"
].map(text => ({text, category:"biologia"}));

const chemistryTopics = [
  "Estudo da matéria", "Átomos", "Tabela Periódica", "Ligações Químicas",
  "Funções Inorgânicas", "Radioatividade", "Estequiometria", "Soluções",
  "Química Orgânica", "Reações Orgânicas", "Polímeros", "Isomeria",
  "Termoquímica", "Eletroquímica", "Cinética Química",
  "Equilíbrio Químico", "Propriedades Coligativas"
].map(text => ({text, category:"quimica"}));

const physicsTopics = [
  "Cinemática","Dinâmica","Ondulatória","Termologia","Estática","Quantidade de Movimento e Impulso","Trabalho e Energia",
  "Potência e Eficiência","Gravitação","Vetores","Eletrostática","Eletrodinâmica","Hidrostática","Óptica","Eletromagnetismo"
].map(text => ({text, category:"fisica"}));

const geographyTopics = [
  "Geografia Física","Meio Ambiente e Energia","Geopolítica","Geografia Econômica","População","Industrialização e Urbanização","Geografia Agrária"
].map(text => ({text, category:"geografia"}));

const historyTopics = [
  "Brasil Colônia","Brasil Império","Brasil República","Civilização pré-colombiana","Pré-história","Antiguidade",
  "Idade média","Idade moderna","Idade contemporânea"
].map(text => ({text, category:"historia"}));

const portuguesTopics = [
  "Funções da linguagem","Figuras da linguagem","Variações linguísticas","Campanhas publicitárias",
  "Gêneros e tipos textuais","Interpretação de Texto","Poemas"
].map(text => ({text, category:"portugues"}));

const filosofiaSociologiaLiteraturaTopics = [
  "Filosofia","Sociologia","Literatura"
].map(text => ({text, category:"filosofia-sociologia-literatura"}));

const allTopics = [
  ...mathTopics,
  ...bioTopics,
  ...chemistryTopics,
  ...physicsTopics,
  ...geographyTopics,
  ...historyTopics,
  ...portuguesTopics,
  ...filosofiaSociologiaLiteraturaTopics
];

// Radar checklist details in memory
let radarDetails = {};

// Store initial order for radar contents by category for proper restore position
let initialRadarOrder = {};

// Initialize order index by category mapping on load
function updateInitialRadarOrder() {
  const radarTopics = JSON.parse(localStorage.getItem('radarTopics') || '[]');
  initialRadarOrder = {};
  const categoryLists = {};
  allTopics.forEach(({text, category})=>{
    if(!categoryLists[category]) categoryLists[category] = [];
    categoryLists[category].push(text);
  });
  // For each category, store an array of topics in initial order filtered by radarTopics present
  Object.entries(categoryLists).forEach(([category,items])=>{
    initialRadarOrder[category] = items.filter(t=>radarTopics.includes(t));
  });
}

// Call on start
updateInitialRadarOrder();

const topicsPanels = {
  radar: document.getElementById('topicsRadar'),
  month: document.getElementById('topicsMonth'),
  week: document.getElementById('topicsWeek')
};

const agendaDiv = document.getElementById("agenda");
const monthsGrid = document.getElementById("monthsGrid");
const weekGrid = document.getElementById("weekGrid");

// Render meses container dynamically
months.forEach(m => {
  const monthDiv = document.createElement("div");
  monthDiv.className = "month";
  monthDiv.dataset.month = m;
  monthDiv.innerHTML = `<h4>${m}</h4><div class="month-content" ondrop="drop(event)" ondragover="allowDrop(event)"></div>`;
  monthsGrid.appendChild(monthDiv);
});
// Render semana container dynamically
days.forEach(day => {
  const weekDayDiv = document.createElement("div");
  weekDayDiv.className = "day";
  weekDayDiv.dataset.day = day;
  weekDayDiv.innerHTML = `<h3>${day}</h3><div class="week-content" ondrop="drop(event)" ondragover="allowDrop(event)"></div>`;
  weekGrid.appendChild(weekDayDiv);
});
// Render agenda dias da semana
days.forEach(day => {
  const dayDiv = document.createElement("div");
  dayDiv.className = "day";
  dayDiv.dataset.day = day;
  dayDiv.innerHTML = `<h3>${day}</h3><div class="day-content" ondrop="drop(event)" ondragover="allowDrop(event)"></div>`;
  agendaDiv.appendChild(dayDiv);
});

// ----- FUNÇÕES PARA RENDERIZAR LISTA DE CONTEÚDOS DA ABA -----------

function renderTopicsPanelRadar() {
  // Radar Topics: carregados do localStorage 'radarTopics'
  let radarTopics = JSON.parse(localStorage.getItem('radarTopics') || '[]');
  topicsPanels.radar.innerHTML = '<h2>Conteúdos Radar</h2>';

  // Agrupa por categoria e ordena pela ordem inicial armazenada
  const groupedByCategory = {};
  radarTopics.forEach(t=>{
    const category = allTopics.find(tp=>tp.text===t)?.category || 'matematica';
    if(!groupedByCategory[category]) groupedByCategory[category] = [];
    groupedByCategory[category].push(t);
  });

  // Para cada categoria, ordena segundo initialRadarOrder
  Object.entries(groupedByCategory).forEach(([category,list])=>{
    if(initialRadarOrder[category]) {
      list.sort((a,b)=>{
        const order = initialRadarOrder[category];
        const ia = order.indexOf(a);
        const ib = order.indexOf(b);
        if(ia === -1 && ib === -1) return a.localeCompare(b);
        if(ia === -1) return 1;
        if(ib === -1) return -1;
        return ia - ib;
      });
    }
    list.forEach(text => {
      const div = createDraggableTopic(text, category);
      topicsPanels.radar.appendChild(div);
    });
  });
}
function renderTopicsPanelMonth() {
  let monthTopics = JSON.parse(localStorage.getItem('monthTopics') || '[]');
  topicsPanels.month.innerHTML = '<h2>Conteúdos Mês</h2>';
  monthTopics.forEach(text => {
    let category = allTopics.find(t => t.text === text)?.category || 'matematica';
    const div = createDraggableTopic(text, category);
    topicsPanels.month.appendChild(div);
  });
}
function renderTopicsPanelWeek() {
  let weekTopics = JSON.parse(localStorage.getItem('weekTopics') || '[]');
  topicsPanels.week.innerHTML = '<h2>Conteúdos Semana</h2>';
  weekTopics.forEach(text => {
    let category = allTopics.find(t => t.text === text)?.category || 'matematica';
    const div = createDraggableTopic(text, category);
    topicsPanels.week.appendChild(div);
  });
}

function createDraggableTopic(text, category){
  const div = document.createElement("div");
  div.classList.add("topic-item", category);
  div.textContent = text;
  div.draggable = true;
  div.addEventListener("dragstart", dragStart);
  return div;
}

// --- Drag and drop handlers ---
function dragStart(event) {
  const el = event.target;
  event.dataTransfer.setData("text/plain", el.textContent);
  event.dataTransfer.effectAllowed = "copyMove";
  if(el.closest('.topicsPanel'))
    event.dataTransfer.setData("source-panel", el.closest('.topicsPanel').id);
  else
    event.dataTransfer.setData("source-panel", "");
}
function allowDrop(event) {
  event.preventDefault();
  event.dataTransfer.dropEffect = "copy";
}

function drop(event) {
  event.preventDefault();
  const topic = event.dataTransfer.getData("text/plain");
  if (!topic) return;
  let container = event.currentTarget;
  if (!container.classList.contains("day-content") &&
      !container.classList.contains("month-content") &&
      !container.classList.contains("radar-content") &&
      !container.classList.contains("week-content") &&
      !container.classList.contains("topicsPanel")) {
    container = container.querySelector(".day-content") || container.querySelector(".month-content") || container.querySelector(".radar-content") || container.querySelector(".week-content") || container;
  }
  if (Array.from(container.children).some(child => child.textContent.replace(/[×✏️]/g,'').trim() === topic)) return;
  let category = allTopics.find(t => t.text === topic)?.category || "matematica";
  const sourcePanel = event.dataTransfer.getData("source-panel");
  if(container.classList.contains("topicsPanel")){
    return;
  }
  else if(container.classList.contains("radar-content")) {
    const radarLevelDiv = container.closest(".radar-level");
    if(!radarLevelDiv) return;
    const level = radarLevelDiv.dataset.level;
    let radarData = JSON.parse(localStorage.getItem('radarData') || '{}');
    radarData[topic] = parseInt(level);
    localStorage.setItem('radarData', JSON.stringify(radarData));
    if (!radarDetails[topic]) {
      radarDetails[topic] = [];
      localStorage.setItem('radarDetails', JSON.stringify(radarDetails));
    }
    let radarTopics = JSON.parse(localStorage.getItem('radarTopics') || '[]');
    radarTopics = radarTopics.filter(t => t.trim() !== topic.trim());
    localStorage.setItem('radarTopics', JSON.stringify(radarTopics));
    renderRadarContent();
    renderTopicsPanelRadar();
  }
  else if(container.classList.contains("month-content")) {
    const monthDiv = container.closest(".month");
    if(!monthDiv) return;
    const newTopic = document.createElement("div");
    newTopic.className = `topic-item ${category}`;
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.className = "month-check";
    checkbox.title = "Marcar como concluído";
    const spanText = document.createElement("span");
    spanText.textContent = topic;
    newTopic.appendChild(checkbox);
    newTopic.appendChild(spanText);
    checkbox.addEventListener('change', () => {
      if(checkbox.checked) newTopic.classList.add('checked');
      else newTopic.classList.remove('checked');
    });
    const removeBtn = document.createElement("span");
    removeBtn.textContent = "×";
    removeBtn.title = "Remover";
    removeBtn.className = "remove-btn";
    removeBtn.onclick = () => newTopic.remove();
    newTopic.appendChild(removeBtn);
    container.appendChild(newTopic);
    let monthTopics = JSON.parse(localStorage.getItem('monthTopics') || '[]');
    monthTopics = monthTopics.filter(t => t.trim() !== topic.trim());
    localStorage.setItem('monthTopics', JSON.stringify(monthTopics));
  }
  else if(container.classList.contains("week-content")) {
    const dayDiv = container.closest(".day");
    if(!dayDiv) return;
    const newTopic = document.createElement("div");
    newTopic.className = `topic-item ${category}`;
    newTopic.textContent = topic;
    const removeBtn = document.createElement("span");
    removeBtn.textContent = "×";
    removeBtn.title = "Remover";
    removeBtn.className = "remove-btn";
    removeBtn.onclick = () => newTopic.remove();
    newTopic.appendChild(removeBtn);
    container.appendChild(newTopic);
    let weekTopics = JSON.parse(localStorage.getItem('weekTopics') || '[]');
    weekTopics = weekTopics.filter(t => t.trim() !== topic.trim());
    localStorage.setItem('weekTopics', JSON.stringify(weekTopics));
  }
  else if(container.classList.contains("day-content")) {
    const dayDiv = container.closest(".day");
    if(!dayDiv) return;
    const newTopic = document.createElement("div");
    newTopic.className = `topic-item ${category}`;
    newTopic.textContent = topic;
    const removeBtn = document.createElement("span");
    removeBtn.textContent = "×";
    removeBtn.title = "Remover";
    removeBtn.className = "remove-btn";
    removeBtn.onclick = () => newTopic.remove();
    newTopic.appendChild(removeBtn);
    container.appendChild(newTopic);
  }
  if(sourcePanel && sourcePanel !== '' && sourcePanel.startsWith('topics') && sourcePanel !== (container.closest('.topicsPanel')?.id)){
    let storageKey = '';
    if(sourcePanel==='topicsRadar') storageKey = 'radarTopics';
    else if(sourcePanel==='topicsMonth') storageKey = 'monthTopics';
    else if(sourcePanel==='topicsWeek') storageKey = 'weekTopics';
    if(storageKey){
      let items = JSON.parse(localStorage.getItem(storageKey) || '[]');
      items = items.filter(t => t.trim() !== topic.trim());
      localStorage.setItem(storageKey, JSON.stringify(items));
      if(storageKey === 'radarTopics') renderTopicsPanelRadar();
      else if(storageKey === 'monthTopics') renderTopicsPanelMonth();
      else if(storageKey === 'weekTopics') renderTopicsPanelWeek();
    }
  }
}

// ---------- Edit Modal ----------
const editModalOverlay = document.getElementById('editModalOverlay');
const checklistText = document.getElementById('checklistText');
const modalTitleName = document.getElementById('modalTitleName');
const saveEditBtn = document.getElementById('saveEditBtn');
const cancelEditBtn = document.getElementById('cancelEditBtn');
let currentEditTopic = null;

function openEditModal(topic) {
  currentEditTopic = topic;
  modalTitleName.textContent = topic;
  const items = radarDetails[topic] || [];
  checklistText.value = items.join('\n');
  editModalOverlay.style.display = 'flex';
  checklistText.focus();
}
function closeEditModal() {
  editModalOverlay.style.display = 'none';
  currentEditTopic = null;
}

saveEditBtn.onclick = () => {
  if(currentEditTopic === null) return;
  const lines = checklistText.value.split('\n').map(l=>l.trim()).filter(l=>l.length>0);
  radarDetails[currentEditTopic] = lines;
  localStorage.setItem('radarDetails', JSON.stringify(radarDetails));
  closeEditModal();
  renderRadarContent();
};
cancelEditBtn.onclick = () => closeEditModal();
editModalOverlay.onclick = e => {
  if(e.target === editModalOverlay) closeEditModal();
};

// ---------- Render Radar ----------
function renderRadarContent() {
  radarDetails = JSON.parse(localStorage.getItem('radarDetails') || '{}');
  const radarData = JSON.parse(localStorage.getItem('radarData') || '{}');
  document.querySelectorAll('#radarLevels .radar-content').forEach(div=> div.innerHTML = '');

  Object.entries(radarData).forEach(([topic, level]) => {
    const container = document.querySelector(`#radarLevels .radar-level[data-level="${level}"] .radar-content`);
    if(!container) return;

    const category = allTopics.find(t => t.text === topic)?.category || "matematica";

    const block = document.createElement('div');
    block.className = `topic-item ${category}`;
    block.draggable = true;

    // Div do titulo clicavel para mostrar/ocultar checklist
    const titleRow = document.createElement('div');
    titleRow.className = 'title-row';
    titleRow.textContent = topic;
    titleRow.style.userSelect = 'none';
    titleRow.style.cursor = 'pointer';

    // Checklist container
    const checklistDiv = document.createElement('div');
    checklistDiv.className = 'checklist';
    checklistDiv.style.display = 'none'; // oculto inicialmente

    const checklistItems = radarDetails[topic] || [];
    if (checklistItems.length > 0) {
      checklistItems.forEach((item, index) => {
        const label = document.createElement('label');
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.dataset.topic = topic;
        checkbox.dataset.index = index;
        checkbox.checked = false; // sempre começa desmarcado
        const span = document.createElement('span');
        span.textContent = item;
        label.appendChild(checkbox);
        label.appendChild(span);
        checklistDiv.appendChild(label);
      });
    }

    // Toggle checklist visibilidade no clique do título
    titleRow.onclick = () => {
      checklistDiv.style.display = checklistDiv.style.display === 'none' ? 'block' : 'none';
    };

    block.appendChild(titleRow);
    block.appendChild(checklistDiv);

    const editBtn = document.createElement('span');
    editBtn.className = 'edit-btn';
    editBtn.innerHTML = '✏️';
    editBtn.title = 'Editar checklist';
    editBtn.onclick = (e) => {
      e.stopPropagation();
      openEditModal(topic);
    };
    block.appendChild(editBtn);

    const removeBtn = document.createElement('span');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '×';
    removeBtn.title = 'Remover do Radar';
    removeBtn.onclick = e => {
      e.stopPropagation();

      let radarDataObj = JSON.parse(localStorage.getItem('radarData') || '{}');
      delete radarDataObj[topic];
      localStorage.setItem('radarData', JSON.stringify(radarDataObj));

      if(radarDetails[topic]){
        delete radarDetails[topic];
        localStorage.setItem('radarDetails', JSON.stringify(radarDetails));
      }

      let radarTopics = JSON.parse(localStorage.getItem('radarTopics') || '[]');

      // Volta conteúdo para sua posição original na lista conteúdos Radar (ordenado por categoria e ordem)
      if(!radarTopics.includes(topic)) {
        const category = allTopics.find(t => t.text === topic)?.category || "matematica";
        const catList = initialRadarOrder[category] || [];
        let insertIndex = radarTopics.length;
        for(let i=0;i<radarTopics.length;i++){
          const t = radarTopics[i];
          const tCat = allTopics.find(x => x.text === t)?.category;
          if(tCat === category){
            const tPos = catList.indexOf(t);
            const topicPos = catList.indexOf(topic);
            if(tPos >=0 && topicPos >=0 && tPos > topicPos){
              insertIndex = i;
              break;
            }
          }
        }
        radarTopics.splice(insertIndex, 0, topic);
      }
      localStorage.setItem('radarTopics', JSON.stringify(radarTopics));

      renderRadarContent();
      renderTopicsPanelRadar();
    };
    block.appendChild(removeBtn);

    block.addEventListener('dragstart', dragStart);
    container.appendChild(block);
  });
}

// ---------- Limpar Radar ----------
document.getElementById('radarClearBtn').onclick = () => {
  if(confirm('Tem certeza que deseja limpar todos os dados do Radar?')){
    localStorage.removeItem('radarData');
    localStorage.removeItem('radarDetails');
    radarDetails = {};
    let allTexts = allTopics.map(t=>t.text);
    localStorage.setItem('radarTopics', JSON.stringify(allTexts));
    updateInitialRadarOrder();
    renderRadarContent();
    renderTopicsPanelRadar();
  }
}

// ---------- Outras funções para agenda, meses, semana e botões permanecem iguais ----------
function safeParse(json) {
  try { return JSON.parse(json);} catch {return {};}
}
function renderMonthContent() {
  const monthData = safeParse(localStorage.getItem('monthAgendaData') || '{}');
  months.forEach(month => {
    const monthDiv = document.querySelector(`.month[data-month="${month}"]`);
    if(monthDiv){
      const contentDiv = monthDiv.querySelector('.month-content');
      contentDiv.innerHTML = '';
      if(monthData[month]){
        monthData[month].forEach(({text, done}) => {
          const category = allTopics.find(t=>t.text === text)?.category || 'matematica';
          const div = document.createElement('div');
          div.className = `topic-item ${category}`;
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'month-check';
          checkbox.title = 'Marcar como concluído';
          checkbox.checked = done;
          const spanText = document.createElement('span');
          spanText.textContent = text;
          div.appendChild(checkbox);
          div.appendChild(spanText);
          if(done) div.classList.add('checked');
          checkbox.onchange = () => {
            if(checkbox.checked) div.classList.add('checked');
            else div.classList.remove('checked');
          };
          const removeBtn = document.createElement('span');
          removeBtn.textContent = '×';
          removeBtn.title = 'Remover';
          removeBtn.className = 'remove-btn';
          removeBtn.onclick = () => {
            div.remove();
          };
          div.appendChild(removeBtn);
          contentDiv.appendChild(div);
        });
      }
    }
  });
}
function renderWeekContent() {
  const weekData = safeParse(localStorage.getItem('weekAgendaData') || '{}');
  days.forEach(day => {
    const dayDiv = document.querySelector(`.day[data-day="${day}"]`);
    if(dayDiv){
      const contentDiv = dayDiv.querySelector('.week-content');
      if(contentDiv){
        contentDiv.innerHTML = '';
        if(weekData[day]){
          weekData[day].forEach(topic => {
            const category = allTopics.find(t => t.text === topic)?.category || 'matematica';
            const div = document.createElement('div');
            div.className = `topic-item ${category}`;
            div.textContent = topic;
            const removeBtn = document.createElement('span');
            removeBtn.textContent = '×';
            removeBtn.title = 'Remover';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = () => div.remove();
            div.appendChild(removeBtn);
            contentDiv.appendChild(div);
          });
        }
      }
    }
  });
}
function renderAgendaContent() {
  const agendaData = safeParse(localStorage.getItem('agendaData') || '{}');
  days.forEach(day => {
    const dayDiv = document.querySelector(`.day[data-day="${day}"]`);
    if(dayDiv){
      const contentDiv = dayDiv.querySelector('.day-content');
      if(contentDiv){
        contentDiv.innerHTML = '';
        if(agendaData[day]){
          agendaData[day].forEach(topic => {
            const category = allTopics.find(t => t.text === topic)?.category || 'matematica';
            const div = document.createElement('div');
            div.className = `topic-item ${category}`;
            div.textContent = topic;
            const removeBtn = document.createElement('span');
            removeBtn.textContent = '×';
            removeBtn.title = 'Remover';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = () => div.remove();
            div.appendChild(removeBtn);
            contentDiv.appendChild(div);
          });
        }
      }
    }
  });
}
function saveRadar() {
  const radarData = {};
  document.querySelectorAll('#radarLevels .radar-level').forEach(levelDiv => {
    const level = levelDiv.dataset.level;
    levelDiv.querySelectorAll('.topic-item').forEach(item => {
      radarData[item.textContent.replace(/[×✏️]/g, '').trim()] = parseInt(level);
    });
  });
  localStorage.setItem('radarData', JSON.stringify(radarData));
  let radarTopics = [];
  document.querySelectorAll('#topicsRadar .topic-item').forEach(item => {
    radarTopics.push(item.textContent);
  });
  localStorage.setItem('radarTopics', JSON.stringify(radarTopics));
  localStorage.setItem('radarDetails', JSON.stringify(radarDetails));
}
function loadRadar() {
  radarDetails = JSON.parse(localStorage.getItem('radarDetails') || '{}');
  updateInitialRadarOrder();
  renderRadarContent();
  renderTopicsPanelRadar();
}
function saveMonth() {
  let monthTopics = [];
  document.querySelectorAll('#topicsMonth .topic-item').forEach(item => monthTopics.push(item.textContent));
  localStorage.setItem('monthTopics', JSON.stringify(monthTopics));
  const monthData = {};
  months.forEach(month => {
    const monthDiv = document.querySelector(`.month[data-month="${month}"]`);
    if(monthDiv) {
      const items = [];
      monthDiv.querySelectorAll('.month-content .topic-item').forEach(div => {
        const checkbox = div.querySelector('input.month-check');
        items.push({
          text: div.querySelector('span').textContent,
          done: checkbox ? checkbox.checked : false
        });
      });
      monthData[month] = items;
    }
  });
  localStorage.setItem('monthAgendaData', JSON.stringify(monthData));
}
function loadMonth() {
  let monthTopics = JSON.parse(localStorage.getItem('monthTopics') || '[]');
  if(monthTopics.length === 0){
    monthTopics = allTopics.map(t=>t.text);
    localStorage.setItem('monthTopics', JSON.stringify(monthTopics));
  }
  renderTopicsPanelMonth();
  const monthData = JSON.parse(localStorage.getItem('monthAgendaData') || '{}');
  months.forEach(month => {
    const monthDiv = document.querySelector(`.month[data-month="${month}"]`);
    if(monthDiv){
      const contentDiv = monthDiv.querySelector('.month-content');
      contentDiv.innerHTML = '';
      if(monthData[month]){
        monthData[month].forEach(({text, done}) => {
          const category = allTopics.find(t=>t.text === text)?.category || 'matematica';
          const div = document.createElement('div');
          div.className = `topic-item ${category}`;
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'month-check';
          checkbox.title = 'Marcar como concluído';
          checkbox.checked = done;
          const spanText = document.createElement('span');
          spanText.textContent = text;
          div.appendChild(checkbox);
          div.appendChild(spanText);
          if(done) div.classList.add('checked');
          checkbox.onchange = () => {
            if(checkbox.checked) div.classList.add('checked');
            else div.classList.remove('checked');
          };
          const removeBtn = document.createElement('span');
          removeBtn.textContent = '×';
          removeBtn.title = 'Remover';
          removeBtn.className = 'remove-btn';
          removeBtn.onclick = () => div.remove();
          div.appendChild(removeBtn);
          contentDiv.appendChild(div);
        });
      }
    }
  });
}
function saveWeek() {
  let weekTopics = [];
  document.querySelectorAll('#topicsWeek .topic-item').forEach(item => weekTopics.push(item.textContent));
  localStorage.setItem('weekTopics', JSON.stringify(weekTopics));
  const weekData = {};
  days.forEach(day => {
    const dayDiv = document.querySelector(`.day[data-day="${day}"]`);
    if(dayDiv){
      const contentDiv = dayDiv.querySelector('.week-content');
      const items = [];
      if(contentDiv){
        contentDiv.querySelectorAll('.topic-item').forEach(item => {
          items.push(item.textContent.replace('×', '').trim());
        });
      }
      weekData[day] = items;
    }
  });
  localStorage.setItem('weekAgendaData', JSON.stringify(weekData));
}
function loadWeek() {
  let weekTopics = JSON.parse(localStorage.getItem('weekTopics') || '[]');
  if(weekTopics.length === 0){
    weekTopics = allTopics.map(t=>t.text);
    localStorage.setItem('weekTopics', JSON.stringify(weekTopics));
  }
  renderTopicsPanelWeek();
  const weekData = JSON.parse(localStorage.getItem('weekAgendaData') || '{}');
  days.forEach(day => {
    const dayDiv = document.querySelector(`.day[data-day="${day}"]`);
    if(dayDiv){
      const contentDiv = dayDiv.querySelector('.week-content');
      if(contentDiv){
        contentDiv.innerHTML = '';
        if(weekData[day]){
          weekData[day].forEach(topic => {
            const category = allTopics.find(t => t.text === topic)?.category || 'matematica';
            const div = document.createElement('div');
            div.className = `topic-item ${category}`;
            div.textContent = topic;
            const removeBtn = document.createElement('span');
            removeBtn.textContent = '×';
            removeBtn.title = 'Remover';
            removeBtn.className = 'remove-btn';
            removeBtn.onclick = () => div.remove();
            div.appendChild(removeBtn);
            contentDiv.appendChild(div);
          });
        }
      }
    }
  });
}
// Exibir a aba selecionada
function showOnly(aba){
  agendaDiv.style.display = 'none';
  document.getElementById('monthsContainer').style.display = 'none';
  document.getElementById('weekContainer').style.display = 'none';
  document.getElementById('radarContainer').style.display = 'none';
  Object.values(topicsPanels).forEach(panel => panel.classList.remove('active'));
  if(aba === 'radar'){
    document.getElementById('radarContainer').style.display = 'flex';
    topicsPanels.radar.classList.add('active');
  }
  else if(aba === 'month'){
    document.getElementById('monthsContainer').style.display = 'block';
    topicsPanels.month.classList.add('active');
  }
  else if(aba === 'week'){
    document.getElementById('weekContainer').style.display = 'block';
    topicsPanels.week.classList.add('active');
  }
  else {
    agendaDiv.style.display = 'grid';
  }
}
// Eventos dos botões de aba
document.getElementById('monthBtn').addEventListener('click', () => {
  showOnly('month');
  loadMonth();
});
document.getElementById('weekBtn').addEventListener('click', () => {
  showOnly('week');
  loadWeek();
});
document.getElementById('radarBtn').addEventListener('click', () => {
  showOnly('radar');
  loadRadar();
});
// Salvar dependendo da aba
document.getElementById('saveBtn').addEventListener('click', () => {
  if(document.getElementById('radarContainer').style.display === 'flex'){
    saveRadar();
    alert('Radar salvo!');
  }
  else if(document.getElementById('monthsContainer').style.display === 'block'){
    saveMonth();
    alert('Agenda do mês salva!');
  }
  else if(document.getElementById('weekContainer').style.display === 'block'){
    saveWeek();
    alert('Agenda da semana salva!');
  }
  else {
    alert('Nenhuma aba ativa para salvar.');
  }
});
// Carregar dependendo da aba
document.getElementById('loadBtn').addEventListener('click', () => {
  if(document.getElementById('radarContainer').style.display === 'flex'){
    loadRadar();
  }
  else if(document.getElementById('monthsContainer').style.display === 'block'){
    loadMonth();
  }
  else if(document.getElementById('weekContainer').style.display === 'block'){
    loadWeek();
  }
  else {
    alert('Nenhuma aba ativa para carregar.');
  }
});
// Ao carregar a página: inicia com 'week' ativo e conteúdos semana
window.addEventListener('load', () => {
  if(!localStorage.getItem('radarTopics')) localStorage.setItem('radarTopics', JSON.stringify(allTopics.map(t=>t.text)));
  if(!localStorage.getItem('monthTopics')) localStorage.setItem('monthTopics', JSON.stringify(allTopics.map(t=>t.text)));
  if(!localStorage.getItem('weekTopics')) localStorage.setItem('weekTopics', JSON.stringify(allTopics.map(t=>t.text)));
  radarDetails = JSON.parse(localStorage.getItem('radarDetails') || '{}');
  updateInitialRadarOrder();
  showOnly('week');
  loadWeek();
  renderTopicsPanelRadar();
  renderTopicsPanelMonth();
  renderTopicsPanelWeek();
});
</script>
</body>
</html>
